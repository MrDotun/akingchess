<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Play vs Aking Master | AKINGCHESS</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Poppins:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --green: #064e3b; --gold: #fbbf24; --dark: #022c22; }
        body { background: var(--green); color: white; font-family: 'Poppins', sans-serif; text-align: center; margin: 0; }
        nav { background: var(--dark); border-bottom: 5px solid var(--gold); padding: 15px 0; }
        nav a { color: white; text-decoration: none; margin: 0 15px; font-weight: bold; text-transform: uppercase; font-size: 0.8rem; }
        .game-container { max-width: 500px; margin: 20px auto; padding: 10px; }
        #myBoard { width: 100%; border: 5px solid var(--gold); border-radius: 5px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .highlight-square { box-shadow: inset 0 0 3px 3px rgba(251, 191, 36, 0.8); }
        .chat-box { background: var(--dark); border: 2px solid var(--gold); margin-top: 20px; padding: 15px; border-radius: 8px; min-height: 80px; }
        #master-talk { font-style: italic; color: var(--gold); font-size: 1.1rem; line-height: 1.4; }
        .controls { margin: 20px 0; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
        button, select { background: var(--gold); border: none; padding: 12px 20px; font-weight: bold; cursor: pointer; border-radius: 5px; font-family: 'Poppins'; }
        
        /* Timer Styles */
        .timer-container { display: flex; justify-content: space-between; margin-bottom: 15px; font-family: 'Cinzel'; font-size: 1.2rem; }
        .timer { background: var(--dark); padding: 5px 15px; border: 2px solid var(--gold); border-radius: 5px; min-width: 100px; transition: 0.3s; }
        .active-timer { background: var(--gold) !important; color: var(--dark) !important; border-color: white; transform: scale(1.05); }
    </style>
</head>
<body>

<nav>
    <a href="index.html">Home</a>
    <a href="about.html">About</a>
    <a href="lichess.html">Lichess</a>
</nav>

<div class="game-container">
    <h2 style="font-family: 'Cinzel'; color: var(--gold); letter-spacing: 2px;">AKING MASTER AI</h2>
    
    <div class="controls">
        <select id="timeControl">
            <option value="3">3 Mins</option>
            <option value="10" selected>10 Mins</option>
            <option value="20">20 Mins</option>
        </select>
        <select id="playerColor">
            <option value="w" selected>White</option>
            <option value="b">Black</option>
        </select>
        <button onclick="startGame()">Start Challenge</button>
    </div>

    <div class="timer-container">
        <div id="white-timer" class="timer">White: --:--</div>
        <div id="black-timer" class="timer">Black: --:--</div>
    </div>

    <div id="myBoard"></div>
    
    <div class="chat-box">
        <p id="master-talk">"Ready for a real challenge?"</p>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

<script>
    var board = null;
    var game = new Chess();
    var playerName = "Player One";
    var userColor = 'w';
    var gameStarted = false;
    var $chat = $('#master-talk');
    var selectedSquare = null;

    var whiteTime = 0, blackTime = 0;
    var timerInterval = null;

    var pieceValues = { p: 10, n: 32, b: 33, r: 50, q: 90, k: 900 };
    var pst = {
        n: [[-5,-4,-3,-3,-3,-3,-4,-5],[-4,-2,0,0,0,0,-2,-4],[-3,0,1,1.5,1.5,1,0,-3],[-3,0.5,1.5,2,2,1.5,0.5,-3],[-3,0,1.5,2,2,1.5,0,-3],[-3,0.5,1,1.5,1.5,1,0.5,-3],[-4,-2,0,0.5,0.5,0,-2,-4],[-5,-4,-3,-3,-3,-3,-4,-5]],
        k: [[2,3,1,0,0,1,3,2],[2,2,0,0,0,0,2,2],[-1,-2,-2,-2,-2,-2,-2,-1],[-2,-3,-3,-4,-4,-3,-3,-2],[-3,-4,-4,-5,-5,-4,-4,-3],[-3,-4,-4,-5,-5,-4,-4,-3],[-3,-4,-4,-5,-5,-4,-4,-3],[-3,-4,-4,-5,-5,-4,-4,-3]]
    };

    function removeHighlights() {
        $('#myBoard .square-55d63').removeClass('highlight-square');
    }

    function formatTime(seconds) {
        let min = Math.floor(seconds / 60);
        let sec = seconds % 60;
        return (min < 10 ? "0" + min : min) + ":" + (sec < 10 ? "0" + sec : sec);
    }

    function updateTimerDisplay() {
        $('#white-timer').text("White: " + formatTime(whiteTime));
        $('#black-timer').text("Black: " + formatTime(blackTime));
        
        $('.timer').removeClass('active-timer');
        if (game.turn() === 'w') {
            $('#white-timer').addClass('active-timer');
        } else {
            $('#black-timer').addClass('active-timer');
        }
    }

    function startTimer() {
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            if (!gameStarted || game.game_over()) return;
            
            if (game.turn() === 'w') {
                whiteTime--;
                if (whiteTime <= 0) handleGameOver("White out of time!");
            } else {
                blackTime--;
                if (blackTime <= 0) handleGameOver("Black out of time!");
            }
            updateTimerDisplay();
        }, 1000);
    }

    function onSquareClick(square) {
        if (!gameStarted || game.game_over() || game.turn() !== userColor) return;

        if (selectedSquare === null) {
            var piece = game.get(square);
            if (piece && piece.color === userColor) {
                selectedSquare = square;
                removeHighlights();
                $('#myBoard .square-' + square).addClass('highlight-square');
            }
            return;
        }

        var move = game.move({ from: selectedSquare, to: square, promotion: 'q' });

        if (move === null) {
            var piece = game.get(square);
            if (piece && piece.color === userColor) {
                selectedSquare = square;
                removeHighlights();
                $('#myBoard .square-' + square).addClass('highlight-square');
            } else {
                selectedSquare = null;
                removeHighlights();
            }
        } else {
            selectedSquare = null;
            removeHighlights();
            board.position(game.fen());
            
            // CRITICAL: Force the turn display to switch immediately
            updateTimerDisplay();
            
            // AI plays instantly
            window.setTimeout(makeAkingMove, 100);
        }
    }

    function getPSTScore(piece, square) {
        var file = square.charCodeAt(0) - 97;
        var rank = 8 - parseInt(square[1]);
        return pst[piece] ? pst[piece][rank][file] : 0;
    }

    function evaluateMove(move) {
        var score = 0;
        var moveObj = game.move(move);
        if (moveObj.captured) score += (pieceValues[moveObj.captured] * 10);
        if (moveObj.san === 'O-O' || moveObj.san === 'O-O-O') score += 40;
        if (game.attackers(userColor, moveObj.to).length > 0) score -= pieceValues[moveObj.piece];
        score += getPSTScore(moveObj.piece, moveObj.to);
        if (game.in_check()) score += 15;
        game.undo();
        return score;
    }

    function makeAkingMove() {
        if (game.game_over()) return;
        var possibleMoves = game.moves({ verbose: true });
        if (possibleMoves.length === 0) return handleGameOver();

        possibleMoves.sort((a, b) => evaluateMove(b) - evaluateMove(a));
        var move = (Math.random() > 0.95 && possibleMoves.length > 1) ? possibleMoves[1] : possibleMoves[0];
        
        game.move(move);
        board.position(game.fen());
        
        // CRITICAL: Switch back to player timer highlight immediately
        updateTimerDisplay();
        
        masterComments(move);
        if (game.game_over()) handleGameOver();
    }

    function masterComments(move) {
        var lines = ["My defense is impenetrable!", "I'm taking the center.", "Big mistake!", "Castling is the mark of a Master."];
        if (game.in_check()) $chat.text("CHECK!");
        else if (Math.random() > 0.8) $chat.text(lines[Math.floor(Math.random() * lines.length)]);
    }

    function handleGameOver(reason) {
        gameStarted = false;
        clearInterval(timerInterval);
        var result = reason || (game.in_checkmate() ? (game.turn() === userColor ? "I WON!" : "YOU WON!") : "DRAW!");
        alert("GAME OVER: " + result);
    }

    function startGame() {
        if (timerInterval) clearInterval(timerInterval);
        
        var nameInput = prompt("Your name, future Grandmaster?");
        playerName = nameInput ? nameInput : "Player One";

        userColor = $('#playerColor').val();
        var mins = parseInt($('#timeControl').val());
        whiteTime = blackTime = mins * 60;
        
        game.reset();
        board.orientation(userColor === 'w' ? 'white' : 'black');
        board.start();
        
        gameStarted = true;
        updateTimerDisplay();
        startTimer();

        $chat.text("Game started! Show me your best moves, " + playerName + "!");

        if (userColor === 'b') {
            window.setTimeout(makeAkingMove, 100);
        }
    }

    board = Chessboard('myBoard', {
        position: 'start',
        draggable: false,
        pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
    });

    $('#myBoard').on('click', '.square-55d63', function () {
        onSquareClick($(this).attr('data-square'));
    });
</script>

</body>
</html>
